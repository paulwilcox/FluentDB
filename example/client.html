<div id='printDiv'></div>

<script type='module'>

    import $$ from "../dist/FluentDB.client.js";
    import sampleIdb from "../node_modules/sampledb/dist/sampledb.idb.js";
    import sample from '../node_modules/sampledb/dist/sampledb.client.js'; 

    let result = $$({
        o: sample.orders,
        p: sample.products,
        c: sample.customers,
        pc: sample.potentialCustomers,
        s: sample.shoplifters 
    })
    .join((o,p) => o.product == p.id)
    .join('left hash', (o,c) => o.customer == c.id)
    .merge('delete', o => o.customer, s => s.id)
    .group(o => o.customer) 
    .reduce(o => ({
        customerId: $$.first(o.customer || 'n/a'), 
        customer: $$.first(o.fullname || 'No Name'),
        orders: $$.count(o.id), 
        price: $$.avg(o.price),
        speed: $$.avg(o.speed),
        rating: $$.avg(o.rating),
        correlation: $$.cor(o.speed, o.rating)
    }))
    .catch(err => console.log(err))
    .execute(o => o);

    console.log(result);

    $$({ r: result })
    .map(r => ({
        ...r,
        price: $$.round(r.price, 2) || '',
        speed: $$.round(r.speed, 2) || '',
        rating: $$.round(r.rating, 2) || '',
        ['correlation (s:r)']: $$.round(r.correlation, 2) || '',
        correlation: undefined
    }))
    .print(r => r, '#printDiv', 'Analysis of Customer Orders')
    .execute();

/*
    fetch('getMongo')
    .then(response => response.json())
    .then(json => console.log(JSON.stringify(json)))
    .catch(e => console.log({e}));
*/

</script>

