<body>
<pre id="result"></pre>

<script type="module">

    import { parser } from '../src/parser.js';

    let dataset = [
        { a: 1, b: 1 },
        { a: 2, b: 2 },
        { a: 3, b: 3 },
        { a: 4, b: 4 }
    ];

    class scroller {
        constructor(func, seed) {
            this.func = func;
            this.seed = seed;
        }
    }

    class directives {
        constructor(func) {
            this.func = func;
        }
    }

    class scrollingDirectives {
        constructor(func) {
            this.func = func;
        }
    }

    class directive {
        constructor(funcName, rowVal) {
            this.funcName = funcName;
            this.rowVal = rowVal;
        }
    }

    let funcMapper = {

        sum: [
            new scroller((a,b) => a + b, 0)
        ],

        count: [
            new scroller((a,b) => a + 1, 0)
        ],  

        avg: [
            new directives(x => ({ s: sum(x), n: count(x) })),
            x => x.s / x.n
        ],

        mad: [
            new directives(x => ({ av: avg(x) })),
            new scrollingDirectives((x,y) => avg(x - y.av)) 
        ]

    };

    let sum = val =>   new directive('sum', val);
    let count = val => new directive('count', val);
    let avg = val =>   new directive('avg', val);
    let mad = val =>   new directive('mad', val);

    let fold = new directives(
        ds => ({
            a: sum(ds.a + 100),
            b: count(ds.b),
            c: avg(ds.a),
            d: mad(ds.a)
        })
    );

    function applyDirective (directive, aggregation, key, stepNum) {

        let step = funcMapper[directive.funcName][stepNum];

        if (step instanceof scroller) 
            aggregation[key] = step.func(
                aggregation[key] || step.seed, 
                directive.rowVal
            );
            
        else if (step instanceof directives) {
            if (!aggregation[key]) 
                aggregation[key] = {};
            aggregation[key] = applyDirectives(step, directive.rowVal, aggregation[key]);
        }        

        else if (step instanceof scrollingDirectives) {
            if (!aggregation[key])
                aggregation[key] = {};
            aggregation[key] = applyDirectives(step, directive.rowVal, )
        }

    }

    function applyDirectives (
        directivesInstance,
        row,
        aggregation
    ) {

        let directives = directivesInstance.func(row);

        for(let key of Object.keys(directives)) 
            applyDirective(directives[key], aggregation, key, 0);

        // TODO: begin futher rounds (below code fails)
        for(let key of Object.keys(directives)) 
            applyDirective(directives[key], aggregation, key, 1);


        return aggregation;

    }

    let aggregation = {};

    for(let row of dataset) 
        aggregation = applyDirectives(fold, row, aggregation);

    console.log({aggregation});

</script>
</body>