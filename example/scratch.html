<div id='printResult'></div>

<script type='module'>

    import { sampleIdb, sampleDataSets } from './data.js';
    import { oneQuery } from '../src/oneQuery.js';

/* TODO:    - join() should work inside groupings, as with
              any other user-facing method possible.
            - print() for external database
            - ressurect merge(), internal, then external
            - aggregators should all reference the common
              aggregate object.  Not have 'data' property
              inside them that they reference (but this 
              will be difficult.  So do it last).
*/

    let db = 
        new oneQuery()
        .addSources({
            sam: oneQuery.idb('sampleIdb'),
            c: sam => 'customers',
            //c: sampleDataSets.customers,
            o: sampleDataSets.orders
        })
        .filter(c => true)
        .map(c => ({ id: c.id, fullname: `name: ${c.fullname}`}))
        .join('oc', 'inner', (o,c) => o.customer == c.id)
        //.group(oc => oc.id)
        .sort(oc => oc.rating)
        .fold(oc => ({
            rating: oneQuery.sum(oc.rating + 5)
        }))
        .print(c => c, '#printResult', 'customers')
        .merge(
            c => c.id, 
            [
                {id: 2, fullname: 'overwritten'},
                {id: 3, fullname: 'inserted'}
            ],
            'upsert'
        )
        .print(c => c, '#printResult', 'customers2')
        .execute();

    console.log(db);


</script>